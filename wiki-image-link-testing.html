<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">

  <link rel="canonical" href="/wiki-image-link-testing" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="description" content="WikilinksDouble bracketed links are converted to Jekyll-ingestible Markdown formatting by the bidirectional_links_generator.rb plugin. However, Obsidian‚Äôs Wi...">

  <meta property="og:site_name" content="My digital garden">

  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">

  <link rel="stylesheet" href="/styles.css">

  
  <meta property="og:description" content="WikilinksDouble bracketed links are converted to Jekyll-ingestible Markdown formatting by the bidirectional_links_generator.rb plugin. However, Obsidian‚Äôs Wi..."/>
  

  
  <meta property="og:title" content="Wiki image link testing">
  <meta property="og:type" content="article">
  

  
  <meta property="article:published_time" content="2022-07-31T17:06:57+01:00">
  <meta property="article:author" content="/">
  

  <meta property="og:url" content="/wiki-image-link-testing" />

  

  <title>
    
      Wiki image link testing &mdash; My digital garden
    
  </title>
</head>

  <body>
    <nav><div>
    <a class="internal-link" href="/"><b>My digital garden</b></a>
</div>
</nav>
    <div class="wrapper">
      <main><article>
  <div>
    <h1>Wiki image link testing</h1>
    <time datetime="2022-07-31T16:32:42+01:00">
      Last updated on July 31, 2022
      
    </time>
  </div>

  <div id="notes-entry-container">
    <content>
      <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<h1 id="wikilinks">Wikilinks</h1>
<p>Double bracketed links are converted to Jekyll-ingestible Markdown formatting by the <code class="language-plaintext highlighter-rouge">bidirectional_links_generator.rb</code> plugin. However, Obsidian‚Äôs Wikilink setting also applies to a proprietary image embed format with double brackets.</p>

<p>I‚Äôm working on another plugin to complement the bidirectional link generator and resolve Obsidian image embeds automatically. This page is for testing the efficacy of the script and the regex I‚Äôm using.</p>

<p>This is a useful reference for <a href="https://ruby-doc.org/core-3.0.1/doc/regexp_rdoc.html" target="_blank">Regex in Ruby</a> and this is a good <a href="https://rubular.com/" target="_blank">Ruby Regex Tester</a>.</p>

<h1 id="version-1">Version 1</h1>
<ul>
  <li>Does not support <code class="language-plaintext highlighter-rouge">"title"</code> in Markdown links because I couldn‚Äôt figure out the regex
    <ul>
      <li>Example:  <code class="language-plaintext highlighter-rouge">![Alt text](tom-wheatley-HdIb-5gRv7U-unsplash 1.jpg "a title")</code>
</li>
      <li>If you use these, the image will break</li>
    </ul>
  </li>
  <li>Fixed the problem with links rendering inside <code class="language-plaintext highlighter-rouge">&lt;span title='There is no note that matches this link.' class='invalid-link'&gt;  &lt;span class='invalid-link-brackets'&gt;[[&lt;/span&gt;  code blocks  &lt;span class='invalid-link-brackets'&gt;]]&lt;/span&gt;&lt;/span&gt;</code>
</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>But it doesn't work in this &lt;span title='There is no note that matches this link.' class='invalid-link'&gt;  &lt;span class='invalid-link-brackets'&gt;[[&lt;/span&gt;  type of block  &lt;span class='invalid-link-brackets'&gt;]]&lt;/span&gt;&lt;/span&gt; because of the extra linebreaks and characters before the tick marks
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Is this also a code block oh shit
</code></pre></div></div>

<h1 id="version-2">Version 2</h1>
<p>I DID A GOOD REGEX!</p>
<ul>
  <li>Code blocks can contain <code class="language-plaintext highlighter-rouge">&lt;span title='There is no note that matches this link.' class='invalid-link'&gt;  &lt;span class='invalid-link-brackets'&gt;[[&lt;/span&gt;  brackets  &lt;span class='invalid-link-brackets'&gt;]]&lt;/span&gt;&lt;/span&gt;</code> without rendering links!</li>
  <li>Markdown images contain <code class="language-plaintext highlighter-rouge">title</code> now!
    <ul>
      <li>
<strong>Update:</strong> Regex is faulty. When title exists, the asset path picks up the space before the <code class="language-plaintext highlighter-rouge">"</code>. Will fix later.</li>
    </ul>
  </li>
</ul>

<p>Edits:</p>
<ul>
  <li>New plugin called <code class="language-plaintext highlighter-rouge">obsidian_images_generator.rb</code> with higher priority than the bidirectional links generator</li>
  <li>Edited bidirectional links generator to exclude codeblocks</li>
</ul>

<p>For those of you who would like to know, this is the regex I added to the end of each section in the generator:</p>
<pre><code class="language-(">
## Helpful References
- https://github.com/github/cmark-gfm/blob/master/src/scanners.re
- https://github.com/jeffreytse/jekyll-spaceship/blob/master/lib/jekyll-spaceship/processors/element-processor.rb
- https://jekyllrb.com/docs/plugins/generators/
- https://stackoverflow.com/questions/45279912/select-all-code-in-md-codeblock

It works! Now you can drag and drop images to Obsidian editor and the asset path will automatically generate. Make sure to follow guidelines in &lt;a class='internal-link' href='/obsidian-setup'&gt;Obsidian Setup&lt;/a&gt;

# Version 3
_In Progress_

## Title Problem
- Turns out `title` is still broken, I didn't actually fix it

## HTML Problem
- Creating HTML such as `&lt;figure&gt;` breaks Markdown images inside the tags because Markdown ignores syntax inside HTML tags
- This isn't a problem for Obsidian style embeds because my generator converts them to HTML
- However, this is a problem for traditional Markdown syntax, especially if you want to have things like `--` converted to an en dash automatically inside a `&lt;figcaption&gt;`
- Solution I'm working on: Utilizing [Obsidian Comment Syntax](https://help.obsidian.md/How+to/Format+your+notes#Comments) to create a way to add HTML tags that don't show up in Obsidian Preview.

## Solution
- According to the [Github Flavored Markdown Docs](https://github.github.com/gfm/#html-blocks), Markdown will not be rendered in HTML blocks **UNLESS:**
	- HTML and Markdown are all on one line
	- HTML start and end tag have a line break between them and Markdown content
	- I verified that this works by adding line breaks in Obsidian. Now I don't have to rewrite Markdown image parsers from scratch anymore!! üò≠üôè

Now the only problem is the `assets/images` path when converting Obsidian embeds to Markdown embeds. Will the obsidian image generator run before the Markdown parser? Let's see!

**I DID IT!!**

That was pretty difficult BUT with the new version of the images generator, you have to be careful to add line breaks when working with Markdown embeds inside HTML elements:

</code></pre>
<figure>

![alt text](inspector.png "Browser as design tool")

</figure>
<p>```</p>

<p>When Markdown embeds don‚Äôt render, try adding line breaks before and after and it might work! What the image generator does is insert <code class="language-plaintext highlighter-rouge">assets/images</code> in the file path when it doesn‚Äôt exist already. Now you can drag + drop images to Obsidian without worrying about asset paths!</p>

<h1 id="testing">Testing</h1>
<p>!<span title="There is no note that matches this link." class="invalid-link">  <span class="invalid-link-brackets">[[</span>  tom-wheatley-HdIb-5gRv7U-unsplash 1.jpg  <span class="invalid-link-brackets">]]</span></span></p>

<p>This image is in a Markdown link to nowhere and also has a title
<a href="https://URL" target="_blank"><img src="tom-wheatley-HdIb-5gRv7U-unsplash%201.jpg" alt="Image alt text" title="a title"></a></p>

<p>Using the note <code class="language-plaintext highlighter-rouge">title</code> variable: <a class="internal-link" href="/cats">a note about cats</a>. Using the note‚Äôs filename: <a class="internal-link" href="/cats">cats</a>. Using the note‚Äôs title, with a label: <a class="internal-link" href="/cats">link to the note about cats using the note title</a>. Using the note‚Äôs filename, with a label: <a class="internal-link" href="/cats">link to the note about cats using the note‚Äôs filename</a>. In all cases, if the double-bracket link does not point to a valid note, the double brackets will still be shown, like this: <span title="There is no note that matches this link." class="invalid-link">  <span class="invalid-link-brackets">[[</span>  there is no note that matches this link  <span class="invalid-link-brackets">]]</span></span>. This is an Obsidian Image. !<span title="There is no note that matches this link." class="invalid-link">  <span class="invalid-link-brackets">[[</span>  tom-wheatley-HdIb-5gRv7U-unsplash 1.jpg  <span class="invalid-link-brackets">]]</span></span>. This is a Markdown image with alt text only. <img src="tom-wheatley-HdIb-5gRv7U-unsplash%201.jpg" alt="Alt text">. This is a Markdown image without alt text but with a title. <img src="tom-wheatley-HdIb-5gRv7U-unsplash%201.jpg" alt="" title="a title">. This is an Obsidian image that links to the assets folder. !<span title="There is no note that matches this link." class="invalid-link">  <span class="invalid-link-brackets">[[</span>  assets/images/tom-wheatley-HdIb-5gRv7U-unsplash 1.jpg  <span class="invalid-link-brackets">]]</span></span>. And another with a slash. !<span title="There is no note that matches this link." class="invalid-link">  <span class="invalid-link-brackets">[[</span>  /assets/images/tom-wheatley-HdIb-5gRv7U-unsplash 1.jpg  <span class="invalid-link-brackets">]]</span></span></p>
</body></html>

    </content>

    <side style="font-size: 0.9em">
      <h3 style="margin-bottom: 1em">Notes mentioning this note</h3>
      
      <div style="display: grid; grid-gap: 1em; grid-template-columns: repeat(1fr);">
      
        <div class="backlink-box">
        <a class="internal-link" href="/obsidian-setup">Obsidian setup</a><br>
        <div style="font-size: 0.9em">Vault
Open new folder as vault and select the main digital garden folder.
</div>
        </div>
      
      </div>
      
    </side>
  </div>
</article>

<hr>

<p>Here are all the notes in this garden, along with their links, visualized as a graph.</p>

<style>
  .links line {
    stroke: #ccc;
    opacity: 0.5;
  }

  .nodes circle {
    cursor: pointer;
    fill: #8b88e6;
    transition: all 0.15s ease-out;
  }

  .text text {
    cursor: pointer;
    fill: #333;
    text-shadow: -1px -1px 0 #fafafabb, 1px -1px 0 #fafafabb, -1px 1px 0 #fafafabb, 1px 1px 0 #fafafabb;
  }

  .nodes [active],
  .text [active] {
    cursor: pointer;
    fill: black;
  }

  .inactive {
    opacity: 0.1;
    transition: all 0.15s ease-out;
  }

  #graph-wrapper {
    background: #fcfcfc;
    border-radius: 4px;
    height: auto;
  }
</style>

<div id="graph-wrapper">
  <script>
    var commentFlag = true;
    
    window.addEventListener("load", loadGraph);
    window.addEventListener("scroll", loadGraph);

    function loadGraph() {
      if (!( document.getElementById("graph-wrapper").getBoundingClientRect().top <
             window.innerHeight * 1.5 &&
          commentFlag)){
        return;
      }
      var oScript = document.createElement("script");
      oScript.src = "https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js";
      oScript.crossOrigin = 'anonymous';
      oScript.integrity =
        "sha512-FHsFVKQ/T1KWJDGSbrUhTJyS1ph3eRrxI228ND0EGaEp6v4a/vGwPWd3Dtd/+9cI7ccofZvl/wulICEurHN1pg==";
      document.body.appendChild(oScript);
      oScript.onload = () => {
        const MINIMAL_NODE_SIZE = 8;
        const MAX_NODE_SIZE = 12;
        const ACTIVE_RADIUS_FACTOR = 1.5;
        const STROKE = 1;
        const FONT_SIZE = 16;
        const TICKS = 200;
        const FONT_BASELINE = 40;
        const MAX_LABEL_LENGTH = 50;

        const graphData = {"edges":[{"source":"70105114115116326811497102116","target":"481161043210011497102116"},{"source":"78111119","target":"661111111071153282101971003250485050"},{"source":"78111119","target":"70105108109115328797116991041011003250485050"},{"source":"481161043210011497102116","target":"70105114115116326811497102116"},{"source":"74101107121108108321141011001051141019911632102114111109","target":"74101107121108108321141011001051141019911632102114111109"},{"source":"83105116101321111141039711010512297116105111110","target":"781111161013210211111410997116116105110103"},{"source":"6532110111116101329798111117116329997116115","target":"781111161013210211111410997116116105110103"},{"source":"78111119","target":"78111119"},{"source":"83105116101321111141039711010512297116105111110","target":"79981151051001059711032115101116117112"},{"source":"8710510710532105109971031013210810511010732116101115116105110103","target":"79981151051001059711032115101116117112"},{"source":"79981151051001059711032115101116117112","target":"83105116101321111141039711010512297116105111110"},{"source":"83105116101321111141039711010512297116105111110","target":"83116121108101323832116104101109101"},{"source":"79981151051001059711032115101116117112","target":"8710510710532105109971031013210810511010732116101115116105110103"},{"source":"781111161013210211111410997116116105110103","target":"6532110111116101329798111117116329997116115"},{"source":"8710510710532105109971031013210810511010732116101115116105110103","target":"6532110111116101329798111117116329997116115"},{"source":"891111171143210210511411511632115101101100","target":"6532110111116101329798111117116329997116115"},{"source":"891111171143210210511411511632115101101100","target":"84105103101114115"},{"source":"781111161013210211111410997116116105110103","target":"6532110111116101329798111117116329997116115"},{"source":"8710510710532105109971031013210810511010732116101115116105110103","target":"6532110111116101329798111117116329997116115"},{"source":"891111171143210210511411511632115101101100","target":"6532110111116101329798111117116329997116115"},{"source":"77111118101321211111171143298111100121321011181011141213210097121","target":"67111110115105115116101110991213210511532107101121"},{"source":"6532110111116101329798111117116329997116115","target":"77111118101321211111171143298111100121321011181011141213210097121"},{"source":"83105116101321111141039711010512297116105111110","target":"891111171143210210511411511632115101101100"},{"source":"67111110115105115116101110991213210511532107101121","target":"891111171143210210511411511632115101101100"},{"source":"891111171143210210511411511632115101101100","target":"891111171143210210511411511632115101101100"},{"source":"891111171143210210511411511632115101101100","target":"236149136235133149237149152236132184236154148"}],"nodes":[{"id":"481161043210011497102116","path":"/0draft","label":"0th draft"},{"id":"661111111071153282101971003250485050","path":"/books2022","label":"Books Read 2022"},{"id":"70105108109115328797116991041011003250485050","path":"/films2022","label":"Films Watched 2022"},{"id":"70105114115116326811497102116","path":"/first-draft","label":"First Draft"},{"id":"74101107121108108321141011001051141019911632102114111109","path":"/jekyll-redirect-from","label":"Jekyll redirect from"},{"id":"781111161013210211111410997116116105110103","path":"/note-formatting","label":"Note formatting"},{"id":"78111119","path":"/now","label":"Now"},{"id":"79981151051001059711032115101116117112","path":"/obsidian-setup","label":"Obsidian setup"},{"id":"83105116101321111141039711010512297116105111110","path":"/site-organization","label":"Site organization"},{"id":"83116121108101323832116104101109101","path":"/style-theme","label":"Style & theme"},{"id":"8710510710532105109971031013210810511010732116101115116105110103","path":"/wiki-image-link-testing","label":"Wiki image link testing"},{"id":"6532110111116101329798111117116329997116115","path":"/cats","label":"A note about cats"},{"id":"84105103101114115","path":"/tigers","label":"Tigers"},{"id":"6532110111116101329798111117116329997116115","path":"/cats","label":"A note about cats"},{"id":"67111110115105115116101110991213210511532107101121","path":"/consistency","label":"Consistency is key"},{"id":"77111118101321211111171143298111100121321011181011141213210097121","path":"/move-your-body-every-day","label":"Move your body every day"},{"id":"891111171143210210511411511632115101101100","path":"/your-first-note","label":"Your first seed"},{"id":"236149136235133149237149152236132184236154148","path":"/%EC%95%88%EB%85%95%ED%95%98%EC%84%B8%EC%9A%94","label":"ÏïàÎÖïÌïòÏÑ∏Ïöî"}]}
        let nodesData = graphData.nodes;
        let linksData = graphData.edges;

        const nodeSize = {};

        const updateNodeSize = () => {
          nodesData.forEach((el) => {
            let weight =
              3 *
              Math.sqrt(
                linksData.filter((l) => l.source.id === el.id || l.target.id === el.id)
                  .length + 1
              );
            if (weight < MINIMAL_NODE_SIZE) {
              weight = MINIMAL_NODE_SIZE;
            } else if (weight > MAX_NODE_SIZE) {
              weight = MAX_NODE_SIZE;
            }
            nodeSize[el.id] = weight;
          });
        };

        const onClick = (d) => {
          window.location = d.path
        };

        const onMouseover = function (d) {
          const relatedNodesSet = new Set();
          linksData
            .filter((n) => n.target.id == d.id || n.source.id == d.id)
            .forEach((n) => {
              relatedNodesSet.add(n.target.id);
              relatedNodesSet.add(n.source.id);
            });

          node.attr("class", (node_d) => {
            if (node_d.id !== d.id && !relatedNodesSet.has(node_d.id)) {
              return "inactive";
            }
            return "";
          });

          link.attr("class", (link_d) => {
            if (link_d.source.id !== d.id && link_d.target.id !== d.id) {
              return "inactive";
            }
            return "";
          });

          link.attr("stroke-width", (link_d) => {
            if (link_d.source.id === d.id || link_d.target.id === d.id) {
              return STROKE * 4;
            }
            return STROKE;
          });
          text.attr("class", (text_d) => {
            if (text_d.id !== d.id && !relatedNodesSet.has(text_d.id)) {
              return "inactive";
            }
            return "";
          });
        };

        const onMouseout = function (d) {
          node.attr("class", "");
          link.attr("class", "");
          text.attr("class", "");
          link.attr("stroke-width", STROKE);
        };

        const sameNodes = (previous, next) => {
          if (next.length !== previous.length) {
            return false;
          }

          const map = new Map();
          for (const node of previous) {
            map.set(node.id, node.label);
          }

          for (const node of next) {
            const found = map.get(node.id);
            if (!found || found !== node.title) {
              return false;
            }
          }

          return true;
        };

        const sameEdges = (previous, next) => {
          if (next.length !== previous.length) {
            return false;
          }

          const set = new Set();
          for (const edge of previous) {
            set.add(`${edge.source.id}-${edge.target.id}`);
          }

          for (const edge of next) {
            if (!set.has(`${edge.source.id}-${edge.target.id}`)) {
              return false;
            }
          }

          return true;
        };

        const graphWrapper = document.getElementById('graph-wrapper')
        const element = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        element.setAttribute("width", graphWrapper.getBoundingClientRect().width);
        element.setAttribute("height", window.innerHeight * 0.8);
        graphWrapper.appendChild(element);

        const reportWindowSize = () => {
          element.setAttribute("width", window.innerWidth);
          element.setAttribute("height", window.innerHeight);
        };

        window.onresize = reportWindowSize;

        const svg = d3.select("svg");
        const width = Number(svg.attr("width"));
        const height = Number(svg.attr("height"));
        let zoomLevel = 1;

        const simulation = d3
          .forceSimulation(nodesData)
          .force("forceX", d3.forceX().x(width / 2))
          .force("forceY", d3.forceY().y(height / 2))
          .force("charge", d3.forceManyBody())
          .force(
            "link",
            d3
              .forceLink(linksData)
              .id((d) => d.id)
              .distance(70)
          )
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("collision", d3.forceCollide().radius(80))
          .stop();

        const g = svg.append("g");
        let link = g.append("g").attr("class", "links").selectAll(".link");
        let node = g.append("g").attr("class", "nodes").selectAll(".node");
        let text = g.append("g").attr("class", "text").selectAll(".text");

        const resize = () => {
          if (d3.event) {
            const scale = d3.event.transform;
            zoomLevel = scale.k;
            g.attr("transform", scale);
          }

          const zoomOrKeep = (value) => (zoomLevel >= 1 ? value / zoomLevel : value);

          const font = Math.max(Math.round(zoomOrKeep(FONT_SIZE)), 1);

          text.attr("font-size", (d) => font);
          text.attr("y", (d) => d.y - zoomOrKeep(FONT_BASELINE) + 8);
          link.attr("stroke-width", zoomOrKeep(STROKE));
          node.attr("r", (d) => {
            return zoomOrKeep(nodeSize[d.id]);
          });
          svg
            .selectAll("circle")
            .filter((_d, i, nodes) => d3.select(nodes[i]).attr("active"))
            .attr("r", (d) => zoomOrKeep(ACTIVE_RADIUS_FACTOR * nodeSize[d.id]));
        };

        const ticked = () => {
          node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
          text
            .attr("x", (d) => d.x)
            .attr("y", (d) => d.y - (FONT_BASELINE - nodeSize[d.id]) / zoomLevel);
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);
        };

        const restart = () => {
          updateNodeSize();
          node = node.data(nodesData, (d) => d.id);
          node.exit().remove();
          node = node
            .enter()
            .append("circle")
            .attr("r", (d) => {
              return nodeSize[d.id];
            })
            .on("click", onClick)
            .on("mouseover", onMouseover)
            .on("mouseout", onMouseout)
            .merge(node);

          link = link.data(linksData, (d) => `${d.source.id}-${d.target.id}`);
          link.exit().remove();
          link = link.enter().append("line").attr("stroke-width", STROKE).merge(link);

          text = text.data(nodesData, (d) => d.label);
          text.exit().remove();
          text = text
            .enter()
            .append("text")
            .text((d) => shorten(d.label.replace(/_*/g, ""), MAX_LABEL_LENGTH))
            .attr("font-size", `${FONT_SIZE}px`)
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "central")
            .on("click", onClick)
            .on("mouseover", onMouseover)
            .on("mouseout", onMouseout)
            .merge(text);

          node.attr("active", (d) => isCurrentPath(d.path) ? true : null);
          text.attr("active", (d) => isCurrentPath(d.path) ? true : null);

          simulation.nodes(nodesData);
          simulation.force("link").links(linksData);
          simulation.alpha(1).restart();
          simulation.stop();

          for (let i = 0; i < TICKS; i++) {
            simulation.tick();
          }

          ticked();
        };

        const zoomHandler = d3.zoom().scaleExtent([0.2, 3]).on("zoom", resize);

        zoomHandler(svg);
        restart();

        function isCurrentPath(notePath) {
          return window.location.pathname.includes(notePath)
        }

        function shorten(str, maxLen, separator = ' ') {
          if (str.length <= maxLen) return str;
          return str.substr(0, str.lastIndexOf(separator, maxLen)) + '...';
        }
        commentFlag = false;
      }
    }
  </script>
</div>

</main>
      <footer>This is the footer. Include anything you'd like here, like a link to an <a class="internal-link" href="/about">About</a> page.
</footer>
    </div>

    <!-- That file is not particularly elegant. This will need a refactor at some point. -->
<style>
  content a.internal-link {
    border-color: #8b88e6;
    background-color: #efefff;
  }

  #tooltip-wrapper {
    background: white;
    padding: 1em;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
    position: absolute;
    width: 400px;
    height: 250px;
    font-size: 0.8em;
    box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    opacity: 0;
    transition: opacity 100ms;
  }

  #tooltip-wrapper:after {
		content: "";
		position: absolute;
		z-index: 1;
		bottom: 0;
		left: 0;
		pointer-events: none;
		background-image: linear-gradient(to bottom, rgba(255,255,255, 0), rgba(255,255,255, 1) 90%);
		width: 100%;
		height: 75px;
  }
</style>

<div style="opacity: 0; display: none;" id='tooltip-wrapper'>
  <div id='tooltip-content'>
  </div>
</div>

<iframe style="display: none; height: 0; width: 0;" id='link-preview-iframe' src="">
</iframe>

<script>
  var opacityTimeout;
  var contentTimeout;
  var transitionDurationMs = 100;

  var iframe = document.getElementById('link-preview-iframe')
  var tooltipWrapper = document.getElementById('tooltip-wrapper')
  var tooltipContent = document.getElementById('tooltip-content')

  var linkHistories = {};

  function hideTooltip() {
    opacityTimeout = setTimeout(function() {
      tooltipWrapper.style.opacity = 0;
      contentTimeout = setTimeout(function() {
        tooltipContent.innerHTML = '';
        tooltipWrapper.style.display = 'none';
      }, transitionDurationMs + 1);
    }, transitionDurationMs)
  }

  function showTooltip(event) {
    var elem = event.target;
    var elem_props = elem.getClientRects()[elem.getClientRects().length - 1];
    var top = window.pageYOffset || document.documentElement.scrollTop

    if (event.target.host === window.location.host) {
      if (!linkHistories[event.target.href]) {
        iframe.src = event.target.href
        iframe.onload = function() {
          tooltipContentHtml = ''
          tooltipContentHtml += '<div style="font-weight: bold;">' + iframe.contentWindow.document.querySelector('h1').innerHTML + '</div>'
          tooltipContentHtml += iframe.contentWindow.document.querySelector('content').innerHTML

          tooltipContent.innerHTML = tooltipContentHtml
          linkHistories[event.target.href] = tooltipContentHtml

          tooltipWrapper.style.display = 'block';
          setTimeout(function() {
            tooltipWrapper.style.opacity = 1;
          }, 1)
        } 
      } else {
        tooltipContent.innerHTML = linkHistories[event.target.href]
        tooltipWrapper.style.display = 'block';
        setTimeout(function() {
          tooltipWrapper.style.opacity = 1;
        }, 1)
      }


      tooltipWrapper.style.left = elem_props.left - (tooltipWrapper.offsetWidth / 2) + (elem_props.width / 2) + "px";
      if ((window.innerHeight - elem_props.top) < (tooltipWrapper.offsetHeight)) {
          tooltipWrapper.style.top = elem_props.top + top - tooltipWrapper.offsetHeight - 10 + "px";
      } else if ((window.innerHeight - elem_props.top) > (tooltipWrapper.offsetHeight)) {
          tooltipWrapper.style.top = elem_props.top + top + 35 + "px";
      }

      if ((elem_props.left + (elem_props.width / 2)) < (tooltipWrapper.offsetWidth / 2)) {
          tooltipWrapper.style.left = "10px";
      } else if ((document.body.clientWidth - elem_props.left - (elem_props.width / 2)) < (tooltipWrapper.offsetWidth / 2)) {
          tooltipWrapper.style.left = document.body.clientWidth - tooltipWrapper.offsetWidth - 20 + "px";
      }
    }
  }

  function setupListeners(linkElement) {
    linkElement.addEventListener('mouseleave', function(_event) {
      hideTooltip();
    });

    tooltipWrapper.addEventListener('mouseleave', function(_event) {
      hideTooltip();
    });

    linkElement.addEventListener('touchend', function(_event) {
      hideTooltip();
    });

    tooltipWrapper.addEventListener('touchend', function(_event) {
      hideTooltip();
    });

    linkElement.addEventListener('mouseenter', function(event) {
      clearTimeout(opacityTimeout);
      clearTimeout(contentTimeout);
      showTooltip(event);
    });

    tooltipWrapper.addEventListener('mouseenter', function(event) {
      clearTimeout(opacityTimeout);
      clearTimeout(contentTimeout);
    });
  }

  document.querySelectorAll('content a').forEach(setupListeners);
</script>

  </body>
</html>
